<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VR Slideshow</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>

    <!-- Page style -->
    <style>
      body {
        background: #111;
        color: #eee;
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      h2 {
        margin-bottom: 5px;
      }

      #imageList img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        margin: 5px;
        border: 2px solid #555;
        border-radius: 4px;
      }

      .thumbWrapper {
        display: inline-block;
        position: relative;
      }

      .removeBtn {
        position: absolute;
        top: -6px;
        right: -6px;
        background: red;
        color: #fff;
        border: none;
        font-size: 14px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
      }

      #startBtn {
        margin-top: 15px;
        padding: 8px 16px;
        background: #eee;
        color: #111;
        border: none;
        cursor: pointer;
        font-size: 16px;
        border-radius: 4px;
      }

      #startBtn:disabled {
        opacity: 0.4;
        cursor: default;
      }

      select,
      input {
        font-size: 16px;
      }

      a {
        color: #66aaff;
      }
    </style>
  </head>

  <body>
    <h2>Select Photos for Slideshow</h2>

    <!-- Single-file picker -->
    <input
      id="filePicker"
      type="file"
      accept="image/*"
      style="margin-bottom: 12px;"
    />

    <br />

    <label>Panel size:</label>
    <select id="panelSize">
      <option value="medium" selected>Medium (recommended)</option>
      <option value="small">Small</option>
      <option value="large">Large</option>
    </select>

    <br /><br />

    <label>Replace interval (sec):</label>
    <input id="replaceInterval" type="number" value="5" min="1" max="30" />

    <br /><br />

    <button id="startBtn" disabled>Start Slideshow</button>

    <p style="margin-top: 10px;">Selected images:</p>
    <div id="imageList"></div>

    <p style="margin-top: 20px; font-size: 14px;">
      Tip: In Quest Browser, tap “Choose Files” to pick images from Gallery or Downloads.<br />
      Included diagram: <a href="assets/diagram.png" target="_blank">diagram.png</a>
    </p>

    <!-- VR Scene -->
    <a-scene
      id="vrScene"
      embedded
      vr-mode-ui="enabled: true"
      style="display:none; height: 100vh;"
    >
      <!-- Camera -->
      <a-entity position="0 1.6 0" camera look-controls></a-entity>

      <!-- Dark background sphere -->
      <a-entity
        geometry="primitive: sphere; radius: 20; segmentsWidth: 64; segmentsHeight: 64;"
        material="color: #000; side: back;"
      ></a-entity>

      <!-- Image panels container -->
      <a-entity id="panelContainer"></a-entity>
    </a-scene>

    <!-- Logic -->
    <script>
      const filePicker = document.getElementById("filePicker");
      const startBtn = document.getElementById("startBtn");
      const imageListDiv = document.getElementById("imageList");

      let imageFiles = []; // actual File objects
      let imageURLs = [];  // generated URL.createObjectURL()

      //------------------------------------------------------------------
      // Add images one at a time
      //------------------------------------------------------------------
      filePicker.addEventListener("change", () => {
        if (filePicker.files.length === 0) return;
        const file = filePicker.files[0];

        imageFiles.push(file);

        const url = URL.createObjectURL(file);
        imageURLs.push(url);

        addThumbnail(url, imageURLs.length - 1);

        startBtn.disabled = imageURLs.length < 1; // change to 8 later if desired
      });

      //------------------------------------------------------------------
      // Show thumbnail + remove button
      //------------------------------------------------------------------
      function addThumbnail(url, index) {
        const wrapper = document.createElement("div");
        wrapper.className = "thumbWrapper";
        wrapper.dataset.index = index;

        const img = document.createElement("img");
        img.src = url;

        const remove = document.createElement("button");
        remove.className = "removeBtn";
        remove.textContent = "×";

        remove.onclick = () => removeImage(index);

        wrapper.appendChild(img);
        wrapper.appendChild(remove);
        imageListDiv.appendChild(wrapper);
      }

      //------------------------------------------------------------------
      // Remove an image
      //------------------------------------------------------------------
      function removeImage(index) {
        imageFiles.splice(index, 1);
        imageURLs.splice(index, 1);

        // Rebuild thumbnail list
        imageListDiv.innerHTML = "";
        imageURLs.forEach((u, i) => addThumbnail(u, i));

        startBtn.disabled = imageURLs.length < 1; // change to 8 when needed
      }

      //------------------------------------------------------------------
      // Start the VR slideshow
      //------------------------------------------------------------------
      startBtn.addEventListener("click", () => {
        document.body.style.display = "none";
        document.getElementById("vrScene").style.display = "block";

        startVRSlideshow();
      });

      //------------------------------------------------------------------
      // VR slideshow logic
      //------------------------------------------------------------------
      function startVRSlideshow() {
        const container = document.getElementById("panelContainer");

        const panelSize = document.getElementById("panelSize").value;
        const replaceSeconds =
          parseFloat(document.getElementById("replaceInterval").value) || 5;

        const panelWidth =
          panelSize === "small"
            ? 2.0
            : panelSize === "large"
            ? 4.5
            : 3.2; // medium

        const maxPanels = 8;
        const activePanels = [];

        function randomPos() {
          const radius = 19;
          const theta = Math.random() * Math.PI * 2;
          const phi = Math.random() * Math.PI;
          const x = radius * Math.sin(phi) * Math.cos(theta);
          const y = radius * Math.cos(phi);
          const z = radius * Math.sin(phi) * Math.sin(theta);
          return { x, y, z };
        }

        function pickImage() {
          return imageURLs[Math.floor(Math.random() * imageURLs.length)];
        }

        function createPanel() {
          const url = pickImage();
          const pos = randomPos();
          const depthOffset = (Math.random() - 0.5) * 0.8;
          const finalPos = {
            x: pos.x * (1 + depthOffset / 20),
            y: pos.y * (1 + depthOffset / 20),
            z: pos.z * (1 + depthOffset / 20),
          };

          const panel = document.createElement("a-plane");
          panel.setAttribute("width", panelWidth);
          panel.setAttribute("height", panelWidth * 0.66);
          panel.setAttribute(
            "material",
            `src:${url}; side:double; shader:standard;`
          );
          panel.setAttribute(
            "position",
            `${finalPos.x} ${finalPos.y} ${finalPos.z}`
          );
          panel.setAttribute("look-at", "[camera]");

          panel.setAttribute(
            "animation__ken",
            "property: position; loop: true; dir: alternate; dur: 5000; " +
              `to: ${finalPos.x + (Math.random() * 1 - 0.5)} ` +
              `${finalPos.y + (Math.random() * 1 - 0.5)} ` +
              `${finalPos.z + (Math.random() * 1 - 0.5)}`
          );

          container.appendChild(panel);
          activePanels.push(panel);
        }

        for (let i = 0; i < Math.min(maxPanels, imageURLs.length); i++) {
          createPanel();
        }

        setInterval(() => {
          if (activePanels.length === 0) return;

          const idx = Math.floor(Math.random() * activePanels.length);
          const old = activePanels[idx];
          old.parentNode.removeChild(old);
          activePanels.splice(idx, 1);

          createPanel();
        }, replaceSeconds * 1000);
      }
    </script>
  </body>
</html>
